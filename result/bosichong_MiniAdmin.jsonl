{"repo_info": {"repo_name": "MiniAdmin", "repo_owner": "bosichong", "repo_url": "https://github.com/bosichong/MiniAdmin"}}
{"type": "source_file", "path": "back/__init__.py", "content": ""}
{"type": "source_file", "path": "back/api_v1.py", "content": "\"\"\"\nAuthor: J.sky bosichong@qq.com\nDate: 2022-11-21 09:32:46\nLastEditors: J.sky bosichong@qq.com\nLastEditTime: 2022-11-21 11:20:48\nFilePath: /MiniAdmin/back/v1/main.py\nv1\n\"\"\"\n\nfrom datetime import datetime, timedelta\nfrom typing import Union\n\nfrom fastapi import APIRouter, Depends, HTTPException, status, Form, Request\nfrom fastapi.security import OAuth2PasswordRequestForm\nfrom sqlalchemy.orm import Session\nfrom jose import JWTError, jwt\n\nimport crud, schemas, models\nfrom database import get_db, get_casbin_e\nfrom schemas import Token, TokenData\nfrom utils import verify_password, APP_TOKEN_CONFIG, oauth2_scheme, get_username_by_token, get_password_hash, verify_enforce, update_array\n\nrouter = APIRouter(\n    prefix=\"/v1\",\n    tags=[\"v1\"],\n    responses={404: {\"description\": \"Not found\"}},  # è¯·æ±‚å¼‚å¸¸è¿”å›æ•°æ®\n)\n\nno_permission = HTTPException(\n    status_code=status.HTTP_403_FORBIDDEN,\n    detail=\"æ‚¨æ²¡æœ‰è¯¥æƒé™ï¼\",\n    headers={\"WWW-Authenticate\": \"Bearer\"},\n)\n\n\ndef return_rule(obj, act):\n    \"\"\"\n    è¿”å›ä¸€ä¸ªéªŒè¯æƒé™çš„è§„åˆ™ï¼ŒåŒ…æ‹¬objã€actã€‚\n    :param obj:\n    :param act:\n    :return:\n    \"\"\"\n    return schemas.Casbin_rule(obj=obj, act=act)\n\n\n######################################\n# access_token ç³»ç»Ÿç™»é™†ç›¸å…³çš„apiæ¥å£\n######################################\n\ndef create_access_token(data: dict, expires_delta: Union[timedelta, None] = None):\n    \"\"\"\n    ç”Ÿæˆtoken\n    :param data:\n    :param expires_delta:\n    :return:\n    \"\"\"\n    to_encode = data.copy()\n    if expires_delta:\n        expire = datetime.utcnow() + expires_delta\n    else:\n        expire = datetime.utcnow() + timedelta(minutes=APP_TOKEN_CONFIG.ACCESS_TOKEN_EXPIRE_MINUTES)\n    to_encode.update({\"exp\": expire})\n    # ç”Ÿæˆå¸¦æœ‰æ—¶é—´é™åˆ¶çš„token\n    encoded_jwt = jwt.encode(to_encode, APP_TOKEN_CONFIG.SECRET_KEY, algorithm=APP_TOKEN_CONFIG.ALGORITHM)\n    return encoded_jwt\n\n\ndef authenticate_user(db: Session, username: str, password: str, ):\n    \"\"\"\n    è®¤è¯ç”¨æˆ·ï¼ŒåŒ…æ‹¬æ£€æµ‹ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¯†ç æ ¡éªŒã€‚\n    :param username:\n    :param password:\n    :param db:\n    :return: æˆåŠŸè¿”å›user\n    \"\"\"\n    user = crud.get_user_by_username(db, username=username)  # è·å–ç”¨æˆ·ä¿¡æ¯\n    # ç”¨æˆ·ä¸å­˜åœ¨\n    if not user:\n        return False\n    # æ ¡éªŒå¯†ç å¤±è´¥\n    if not verify_password(password, user.hashed_password):\n        return False\n    # æˆåŠŸè¿”å›user\n    return user\n\n\n@router.post(\"/token\", response_model=Token)\nasync def login_for_access_token(form_data: OAuth2PasswordRequestForm = Depends(), db: Session = Depends(get_db)):\n    # è·å–ç”¨æˆ·,å¦‚æœæ²¡æœ‰æˆ–å¯†ç é”™è¯¯å¹¶æç¤ºé”™è¯¯.\n    user = authenticate_user(db, form_data.username, form_data.password)\n    if not user:\n        raise HTTPException(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=\"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯!\",\n            headers={\"WWW-Authenticate\": \"Bearer\"},\n        )\n\n    if user.is_active:\n        raise HTTPException(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=\"å¸å·å·²è¢«ç¦ç”¨!\",\n            headers={\"WWW-Authenticate\": \"Bearer\"},\n        )\n    access_token_expires = timedelta(minutes=APP_TOKEN_CONFIG.ACCESS_TOKEN_EXPIRE_MINUTES)\n    # ç”Ÿæˆtoken\n    access_token = create_access_token(\n        data={\"sub\": user.username}, expires_delta=access_token_expires\n    )\n    return {\"access_token\": access_token, \"token_type\": \"bearer\"}\n\n\n######################################\n# Userç›¸å…³çš„apiæ¥å£\n######################################\n\n@router.post('/user/create_user')\nasync def create_user(user: schemas.UserCreate, db: Session = Depends(get_db)):\n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"ç”¨æˆ·åç§°é‡å¤ï¼\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n    # æ³¨å†Œç”¨æˆ·åç§°ä¸èƒ½ä¸ç”¨æˆ·ç»„çš„role_keyé‡å¤ã€‚\n    role = crud.get_role_by_role_key(db, user.username)\n    if role:\n        raise credentials_exception\n    return crud.create_user(db, user.username, user.password, user.sex, user.email)\n\n\n@router.get(\"/user/me\", response_model=schemas.User)\nasync def read_users_me(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    \"\"\"\n    è¿”å›å½“å‰ç”¨æˆ·çš„èµ„æ–™\n    \"\"\"\n    username = get_username_by_token(token)\n    user = crud.get_user_by_username(db, username)\n    return user\n\n\n@router.get('/user/user_by_id', response_model=schemas.User)\nasync def get_user_by_id(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db), user_id: int = 0):\n    \"\"\"\n    è·å–æŒ‡å®šidç”¨æˆ·çš„èµ„æ–™\n    :param token:\n    :param db:\n    :param user_id:\n    :return: schemas.User\n    \"\"\"\n    if verify_enforce(token, return_rule('User', 'read')):\n        return crud.get_user_by_id(db, user_id)\n    else:\n        raise no_permission\n\n\n@router.get('/user/get_users', response_model=schemas.Users)\nasync def get_users(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db), skip: int = 0, limit: int = 10, keyword: str = ''):\n    users = schemas.Users(users=crud.get_users(db, skip, limit, keyword), count=crud.get_users_count_by_keyword(db, keyword))\n    return users\n\n\n@router.get('/user/active_change')\nasync def user_active_change(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db), user_id: int = 0):\n    \"\"\"\n    ä¿®æ”¹ç”¨æˆ·é”å®š\n    :param token:\n    :param db:\n    :param user_id:\n    :return:\n    \"\"\"\n    if verify_enforce(token, return_rule('User', 'update')):\n        return crud.active_change(db, user_id)\n    else:\n        raise no_permission\n\n\n@router.get('/user/delete_user')\nasync def delete_user(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db), user_id: int = 0):\n    \"\"\"\n    åˆ é™¤ç”¨æˆ·\n    :param token:\n    :param db:\n    :param user_id:\n    :return:\n    \"\"\"\n    if verify_enforce(token, return_rule('User', 'delete')):\n        return crud.delete_user_by_id(db, user_id)\n    else:\n        raise no_permission\n\n\n@router.post('/user/update_user')\nasync def update_user(user: schemas.UserUpdate, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    \"\"\"\n    ä¿®æ”¹ç”¨æˆ·èµ„æ–™\n    :param user:\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n    if verify_enforce(token, return_rule('User', 'update')):\n        credentials_exception = HTTPException(\n            status_code=status.HTTP_401_UNAUTHORIZED,\n            detail=\"ç”¨æˆ·åç§°é‡å¤ï¼\",\n            headers={\"WWW-Authenticate\": \"Bearer\"},\n        )\n        u = crud.get_user_by_id(db, user.user_id)\n        # ä¿®æ”¹ç”¨æˆ·åç§°ä¸èƒ½ä¸ç”¨æˆ·ç»„çš„role_keyé‡å¤ã€‚\n        role = crud.get_role_by_role_key(db, user.username)\n        if role:\n            raise credentials_exception\n        u.username = user.username\n        u.email = user.email\n        u.sex = user.sex\n        u.remark = user.remark\n        u.avatar = user.avatar\n        if user.password != '':\n            hashed_password = get_password_hash(user.password)\n            u.hashed_password = hashed_password\n        try:\n            db.commit()\n            return True\n        except:\n            return False\n    else:\n        raise no_permission\n\n\n@router.post('/user/update_me')\nasync def update_me(user: schemas.UserUpdate, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    \"\"\"\n    ä¿®æ”¹ç”¨æˆ·èµ„æ–™\n    :param user:\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"Could not validate credentials\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n    username = get_username_by_token(token)\n    me = crud.get_user_by_username(db,username)\n    if user.user_id == me.id:\n        u = crud.get_user_by_id(db, user.user_id)\n        u.username = user.username\n        u.email = user.email\n        u.sex = user.sex\n        u.remark = user.remark\n        u.avatar = user.avatar\n        if user.password != '':\n            hashed_password = get_password_hash(user.password)\n            u.hashed_password = hashed_password\n        try:\n            db.commit()\n            return True\n        except:\n            raise credentials_exception\n    else:\n        raise credentials_exception\n\n\n@router.post('/user/change_user_role')\nasync def change_user_role(data: schemas.ChangeUserRole, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    \"\"\"\n    ä¿®æ”¹ç”¨æˆ·æ‹¥æœ‰çš„ç”¨æˆ·ç»„\n    :param data:\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n    if verify_enforce(token, return_rule('User', 'update')):\n        # å°†ç”¨æˆ·ç»„åç§°æ”¹æˆrole_key\n        role_keys = []\n        for name in data.names:\n            role = crud.get_role_by_name(db, name)\n            role_keys.append(role.role_key)\n        return crud.change_user_role(db, data.user_id, role_keys)\n    else:\n        raise no_permission\n\n\n@router.get('/user/get_user_role')\nasync def get_user_role(user_id: int, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    \"\"\"\n    è·å–ç”¨æˆ·æ‰€æ‹¥æœ‰çš„ç”¨æˆ·ç»„\n    :param user_id:\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n\n    if verify_enforce(token, return_rule('User', 'read')):\n        user = crud.get_user_by_id(db, user_id)\n        roles = crud.get_roles(db)\n        options = []  # æ‰€æœ‰çš„æƒé™ç»„åç§°\n        for role in roles:\n            options.append(role.name)\n\n        checkeds = []  # å½“å‰ç”¨æˆ·æ‰€æ‹¥æœ‰çš„ç”¨æˆ·ç»„\n        crs = crud.get_casbin_rules_by_username(db, user.username)\n        for cr in crs:\n            role = crud.get_role_by_role_key(db, cr.v1)\n            checkeds.append(role.name)\n        return {'options': options, 'checkeds': checkeds}\n    else:\n        raise no_permission\n\n\n######################################\n# roleç›¸å…³çš„apiæ¥å£\n######################################\n@router.get('/role/get_roles')\nasync def get_roles(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    return crud.get_roles(db)\n\n\n@router.post('/role/create_role')\nasync def create_role(role: schemas.Role, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db), ):\n    \"\"\"\n    åˆ›å»º role\n    :param role:\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n    if verify_enforce(token, return_rule('Role', 'create')):\n        new_role = models.Role()\n        new_role.name = role.name\n        new_role.role_key = role.role_key\n        new_role.description = role.description\n        new_role.user_id = int(role.user_id)\n        return crud.create_role(db, new_role)\n    else:\n        raise no_permission\n\n\n@router.get('/role/get_role_by_id')\nasync def get_role_by_id(role_id: int, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    if verify_enforce(token, return_rule('Role', 'read')):\n        return crud.get_role_by_id(db, role_id)\n    else:\n        raise no_permission\n\n\n@router.post('/role/update_role')\nasync def update_role_by_id(role: schemas.EditRole, token: str = Depends(oauth2_scheme),\n                            db: Session = Depends(get_db)):\n    \"\"\"\n    ä¿®æ”¹role\n    :param role:\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n    if verify_enforce(token, return_rule('Role', 'update')):\n        new_role = models.Role()\n        new_role.name = role.name\n        new_role.role_key = role.role_key\n        new_role.description = role.description\n        return crud.update_role_by_id(db, role.old_role_id, new_role)\n    else:\n        raise no_permission\n\n\n@router.get('/role/delete_role')\nasync def delete_role_by_id(role_id: int, token: str = Depends(oauth2_scheme),\n                            db: Session = Depends(get_db)):\n    if verify_enforce(token, return_rule('Role', 'delete')):\n        return crud.delete_role_by_id(db, role_id)\n    else:\n        raise no_permission\n\n\n@router.get('/role/get_coca')\nasync def get_co_ca(role_id: int, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    \"\"\"\n    è¿”å›ç”¨æˆ·ç»„roleæ‰€åŒ…å«çš„æƒé™ç”¨äºå‰ç«¯ä½¿ç”¨å¤šé€‰æ¡†æ¥å±•ç¤º\n    <div  v-for=\"(item,index) of options.value\" >\n        <a-checkbox-group v-model:value=\"checkeds.value[index]\" :options=\"item\" />\n    </div>\n\n    å…¶ä¸­optionsã€checkedsæ˜¯ä¸¤ä¸ªæ•°ç»„ï¼Œå‰è€…åŒ…æ‹¬äº†æ‰€æœ‰çš„æƒé™åˆ—è¡¨ï¼Œåè€…åªåŒ…æ‹¬å½“å‰ç”¨æˆ·ç»„æ‰€æ‹¥æœ‰çš„æƒé™ã€‚\n    :param role_id: ç”¨æˆ·åˆ™çš„id\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n    cos = crud.get_casbin_objects(db)\n    cas = crud.get_casbin_actions(db)\n    role = crud.get_role_by_id(db, role_id)\n    all_co_ca = []  # æ‹¼è£…æ‰€æœ‰æƒé™çš„åˆ—è¡¨\n    co_key_name = {}  # ç»„è£…ä¸€ä¸ªå­—å…¸ï¼Œé‡Œè¾¹çš„èµ„æºkeyå¯¹åº”name\n    ca_key_name = {}  # ç»„è£…ä¸€ä¸ªå­—å…¸ï¼Œé‡Œè¾¹çš„åŠ¨ä½œkeyå¯¹åº”name\n    # ä¸€ä¸ªä¸´æ—¶çš„èµ„æºå’ŒåŠ¨ä½œçš„åç§°æ•°ç»„ï¼Œç±»ä¼¼ä¸‹è¾¹\n    # ['ç”¨æˆ·ç®¡ç†', 'å¢', 'ç”¨æˆ·ç®¡ç†', 'åˆ ', 'ç”¨æˆ·ç®¡ç†', 'æ”¹', 'è§’è‰²ç®¡ç†', 'å¢', 'è§’è‰²ç®¡ç†', 'åˆ ', 'è§’è‰²ç®¡ç†', 'æ”¹']\n\n    \"\"\"\n    # ç¾¤é‡Œå¤§ä½¬æä¾›çš„ç®—æ³•ã€‚\n    input = ['ç”¨æˆ·ç®¡ç†', 'å¢', 'ç”¨æˆ·ç®¡ç†', 'åˆ ', 'ç”¨æˆ·ç®¡ç†', 'æ”¹', 'ç”¨æˆ·ç®¡ç†', 'æŸ¥', 'ç”¨æˆ·ç®¡ç†', 'æ˜¾', 'è§’è‰²ç®¡ç†', 'å¢', 'è§’è‰²ç®¡ç†', 'åˆ ', 'è§’è‰²ç®¡ç†', 'æ”¹', 'è§’è‰²ç®¡ç†', 'æŸ¥', 'è§’è‰²ç®¡ç†', 'æ˜¾', 'èµ„æºç®¡ç†', 'å¢', 'èµ„æºç®¡ç†', 'åˆ ', 'èµ„æºç®¡ç†', 'æ”¹', 'èµ„æºç®¡ç†', 'æŸ¥', 'èµ„æºç®¡ç†', 'æ˜¾', 'åŠ¨ä½œç®¡ç†', 'å¢', 'åŠ¨ä½œç®¡ç†', 'åˆ ', 'åŠ¨ä½œç®¡ç†', 'æ”¹', 'åŠ¨ä½œç®¡ç†', 'æŸ¥', 'åŠ¨ä½œç®¡ç†', 'æ˜¾', 'èµ„æºåˆ†ç±»', 'å¢', 'èµ„æºåˆ†ç±»', 'åˆ ', 'èµ„æºåˆ†ç±»', 'æ”¹', 'èµ„æºåˆ†ç±»', 'æŸ¥', 'èµ„æºåˆ†ç±»', 'æ˜¾']\n    \n    m = dict()\n    key = ''\n    for i in range (len(input)):\n        if i % 2 == 0:\n           key = input[i]\n        else:\n            if m.get(key) != None: \n                m[key].append(input[i])\n            else:\n                m[key] = [input[i]]\n    \n    res = []\n    \n    for key in m.keys():\n        item = [key]\n        item = item + m[key]\n        res.append(item)\n    \n    print(res)\n    \n    \n    \"\"\"\n    cks = []\n    checkeds = []  # å½“å‰ç”¨æˆ·ç»„æ‰€æ‹¥æœ‰çš„æƒé™\n    for co in cos:\n        coca = [co.name]\n        for ca in cas:\n            coca.append(ca.name)\n        all_co_ca.append(coca)\n\n    for co in cos:\n        co_key_name[co.object_key] = co.name\n    for ca in cas:\n        ca_key_name[ca.action_key] = ca.name\n\n    crs = crud.get_casbin_rules_by_role_key(db, role.role_key)\n\n    for cr in crs:\n        cks.append(co_key_name[cr.v1])\n        cks.append(ca_key_name[cr.v2])\n    # print(cks)\n    temp_nams = list()\n    for ck in cks:\n        if len(temp_nams) == 0:\n            temp_nams.append(ck)\n            # print(temp_nams)\n        elif temp_nams[0] == ck:\n            pass\n        elif ck in co_key_name.values() and ck != temp_nams[0]:\n            checkeds.append(temp_nams)\n            temp_nams = [ck]\n        elif ck in ca_key_name.values() and ck not in temp_nams:\n            temp_nams.append(ck)\n            # print(temp_nams)\n    checkeds.append(temp_nams)\n    # print(checkeds)\n    # print(all_co_ca)\n    # print(update_array(all_co_ca,checkeds))\n    return {'options': all_co_ca, 'checkeds': update_array(all_co_ca,checkeds)}\n\n\n@router.post('/role/change_role')\nasync def change_role(cr_data: schemas.ChangeRole, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    \"\"\"\n    ä¿®æ”¹ç”¨æˆ·ç»„æ‰€æ‹¥æœ‰çš„æƒé™\n    :param cr_data:\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n    if verify_enforce(token, return_rule('Role', 'update')):\n        role = crud.get_role_by_id(db, cr_data.role_id)\n        cos = crud.get_casbin_objects(db)\n        cas = crud.get_casbin_actions(db)\n        co_name_key = {}  # ç»„è£…ä¸€ä¸ªå­—å…¸ï¼Œé‡Œè¾¹çš„èµ„æºnameå¯¹åº”key\n        ca_name_key = {}  # ç»„è£…ä¸€ä¸ªå­—å…¸ï¼Œé‡Œè¾¹çš„åŠ¨ä½œnameå¯¹åº”key\n        change_crs = []  # å‡†å¤‡è¦æ›´æ–°æ·»åŠ çš„æ‰€æœ‰casbinruleã€‚\n\n        for co in cos:\n            co_name_key[co.name] = co.object_key\n        for ca in cas:\n            ca_name_key[ca.name] = ca.action_key\n\n        for crs in cr_data.checkeds:\n            if crs:\n                try:\n                    object_key = co_name_key[crs[0]]\n                except:\n                    return False\n                cr_name = crs[0]\n                # print(len(crs))\n                if len(crs) <= 1:\n                    return False\n                for cr in crs:\n                    # print(cr, cr_name)\n                    if cr != cr_name:\n                        # print(role.role_key, object_key, ca_name_key[cr])\n                        change_crs.append(models.CasbinRule(ptype='p', v0=role.role_key, v1=object_key, v2=ca_name_key[cr]))\n        # print(change_crs)\n        return crud.change_role_casbinrules(db, role.role_key, change_crs)\n    else:\n        raise no_permission\n\n\n######################################\n# CasbinObjectç›¸å…³çš„apiæ¥å£\n######################################\n\n@router.get('/co/get_cos')\nasync def get_cos(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    return crud.get_casbin_objects(db)\n\n\n@router.post('/co/create_co')\nasync def create_casbin_object(co: schemas.createCasbinObject, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    \"\"\"\n    åˆ›å»ºèµ„æº\n    :param co:\n    :param token:\n    :param db:\n    :return:\n    \"\"\"\n    if verify_enforce(token, return_rule('CasbinObject', 'create')):\n        new_co = models.CasbinObject()\n        new_co.name = co.name\n        new_co.object_key = co.object_key\n        new_co.description = co.description\n        new_co.user_id = co.user_id\n        return crud.create_casbin_object(db, new_co)\n    else:\n        raise no_permission\n\n\n@router.get('/co/get_co')\nasync def get_casbin_object(co_id: int, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    return crud.get_casbin_object_by_id(db, co_id)\n\n\n@router.post('/co/update_co')\nasync def update_casbin_object_by_id(co: schemas.EditCasbinObject, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    if verify_enforce(token, return_rule('CasbinObject', 'update')):\n        return crud.update_casbin_object(db, co.old_co_id, co.name, co.object_key, co.description)\n    else:\n        raise no_permission\n\n\n@router.get('/co/delete_co')\nasync def delete_casbin_object_by_id(co_id: int, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    if verify_enforce(token, return_rule('CasbinObject', 'read')):\n        return crud.delete_casbin_object_by_id(db, co_id)\n    else:\n        raise no_permission\n\n\n######################################\n# CasbinActionç›¸å…³çš„apiæ¥å£\n######################################\n\n@router.get('/ca/get_cas')\nasync def get_cas(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    return crud.get_casbin_actions(db)\n\n\n@router.post('/ca/create_ca')\nasync def create_ca(ca: schemas.createCasbinAction, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    if verify_enforce(token, return_rule('CasbinAction', 'create')):\n        new_ca = models.CasbinAction()\n        new_ca.name = ca.name\n        new_ca.action_key = ca.action_key\n        new_ca.description = ca.description\n        new_ca.user_id = ca.user_id\n        return crud.create_casbin_action(db, new_ca)\n    else:\n        raise no_permission\n\n\n@router.get('/ca/get_ca')\nasync def get_ca(ca_id: int, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    return crud.get_casbin_action_by_id(db, ca_id)\n\n\n@router.post('/ca/update_ca')\nasync def update_ca(ca: schemas.EditCasbinAction, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    if verify_enforce(token, return_rule('CasbinAction', 'update')):\n        return crud.update_casbin_action_by_id(db, ca.old_ca_id, ca.name, ca.action_key, ca.description)\n    else:\n        raise no_permission\n\n\n@router.get('/ca/delete_ca')\nasync def delete_ca(ca_id: int, token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    if verify_enforce(token, return_rule('CasbinAction', 'delete')):\n        return crud.delete_casbin_action_by_id(db, ca_id)\n    else:\n        raise no_permission\n\n\n######################################\n# Casbin æƒé™éªŒè¯çš„apiæ¥å£\n######################################\n\n@router.get('/get_menu')\nasync def get_menu_permissions(token: str = Depends(oauth2_scheme), db: Session = Depends(get_db)):\n    rules = [\n        ['User', 'show'],\n        ['Role', 'show'],\n        ['CasbinObject', 'show'],\n        ['CasbinAction', 'show'],\n    ]\n    menu = {}\n    for r in rules:\n        if verify_enforce(token, schemas.Casbin_rule(obj=r[0], act=r[1])):\n            menu[r[0]] = True\n        else:\n            menu[r[0]] = False\n    # print(menu)\n    return menu\n\n\n@router.post('/isAuthenticated')\nasync def isAuthenticated(rule: schemas.Casbin_rule, token: str = Depends(oauth2_scheme), ):\n    \"\"\"\n    è·¯ç”±é¡µé¢çš„æƒé™éªŒè¯æ¥å£\n    :param rule:\n    :param token:\n    :return:\n    \"\"\"\n    # print(\"è·¯ç”±æƒé™éªŒè¯\")\n    return verify_enforce(token, rule)\n\n\n@router.post(\"/casbin_rule_test\")\nasync def casbin_test(token: str = Depends(oauth2_scheme)):\n    \"\"\"\n    ä¸€ä¸ªå…³äºæƒé™æ¥å£çš„ç®€å•æµ‹è¯•\n    :param token:\n    :return:\n    \"\"\"\n    rule = schemas.Casbin_rule(obj='User', act='read')\n    if verify_enforce(token, rule):\n        return True\n    else:\n        return False\n"}
{"type": "source_file", "path": "back/main.py", "content": "'''\nAuthor: J.sky bosichong@qq.com\nDate: 2022-11-21 09:16:37\nLastEditors: J.sky bosichong@qq.com\nLastEditTime: 2022-11-21 09:44:08\nFilePath: /MiniAdmin/back/main.py\nMiniAdmin,ä¸€ä¸ªç®€æ´è½»å¿«çš„åå°ç®¡ç†æ¡†æ¶\n'''\n\nimport os\nimport sys\n\n# å°†å½“å‰ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿå˜é‡ä¸­\nBASE_DIR = os.path.dirname(os.path.abspath(__file__))\nsys.path.append(BASE_DIR)\n\nfrom fastapi import FastAPI\nfrom fastapi.middleware.cors import CORSMiddleware  # è§£å†³è·¨åŸŸ\nimport uvicorn as uvicorn\n\nfrom database import Base, engine, get_db\nfrom api_v1 import router\nimport crud\n\nfrom fastapi.responses import HTMLResponse  # å“åº”html\nfrom fastapi.staticfiles import StaticFiles  # è®¾ç½®é™æ€ç›®å½•\n\n__version__ = \"0.1.1\"\ndescription = '''Mini Admin,ä¸€ä¸ªç®€æ´è½»å¿«çš„åå°ç®¡ç†æ¡†æ¶.æ”¯æŒæ‹¥æœ‰å¤šç”¨æˆ·ç»„çš„RBACç®¡ç†åå° ğŸš€'''\n\napp = FastAPI(\n    title=\"MiniAdmin\",\n    description=description,\n    version=__version__,\n    terms_of_service=\"#\",\n    license_info={\n        \"name\": \"MIT\",\n        \"url\":  \"https://opensource.org/licenses/MIT\",\n    },\n)\n\n# é…ç½®å…è®¸åŸŸå\norigins = [\n    \"http://localhost\",\n    \"http://localhost:5173\",\n    \"http://127.0.0.1:5173\",\n\n]\n# é…ç½®å…è®¸åŸŸååˆ—è¡¨ã€å…è®¸æ–¹æ³•ã€è¯·æ±‚å¤´ã€cookieç­‰\napp.add_middleware(\n    CORSMiddleware,\n    allow_origins=origins,\n    allow_credentials=True,\n    allow_methods=[\"*\"],\n    allow_headers=[\"*\"],\n)\n\napp.include_router(router)\n\n# é™æ€èµ„æº\napp.mount(\"/dist\", StaticFiles(directory=os.path.join(BASE_DIR, 'dist')), name=\"dist\")\napp.mount(\"/assets\", StaticFiles(directory=os.path.join(BASE_DIR, 'dist/assets')), name=\"assets\")\n\n# åˆ é™¤è¡¨ï¼Œå½“æ›´æ–°è¡¨çš„ç»“æ„æ—¶å¯ä»¥ä½¿ç”¨ï¼Œä½†æ˜¯ä¼šåˆ é™¤æ‰€æœ‰æ•°æ®ã€‚æ…ç”¨ï¼ï¼ï¼ï¼\n# models.Base.metadata.drop_all(bind=engine)\n# åœ¨æ•°æ®åº“ä¸­ç”Ÿæˆè¡¨ç»“æ„\nBase.metadata.create_all(bind=engine)\n# ç”Ÿæˆåˆå§‹åŒ–æ•°æ®ï¼Œæ·»åŠ äº†ä¸€ä¸ªè¶…çº§ç®¡ç†å‘˜å¹¶èµ‹äºˆæ‰€æœ‰ç®¡ç†æƒé™ï¼Œä»¥åŠä¸€äº›è™šæ‹Ÿçš„ç”¨æˆ·ã€‚\ncrud.create_data(next(get_db()))\n\n\n@app.get(\"/\")\ndef main():\n    html_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'dist', 'index.html')\n    html_content = ''\n    with open(html_path, encoding=\"utf-8\") as f:\n        html_content = f.read()\n    return HTMLResponse(content=html_content, status_code=200)\n\n\nif __name__ == '__main__':\n    print('å°‘å¹´ï¼Œæˆ‘çœ‹ä½ éª¨éª¼ç²¾å¥‡ï¼Œæ˜¯ä¸‡ä¸­æ— ä¸€çš„ç¼–ç¨‹å¥‡æ‰ï¼Œæœ‰ä¸ªç¨‹åºå‘˜å¤§ä½¬qqç¾¤[217840699]ä½ åŠ ä¸‹å§!ç»´æŠ¤ä¸–ç•Œå’Œå¹³å°±é ä½ äº†ï¼')\n    uvicorn.run(app='main:app', host=\"127.0.0.1\", port=8000, reload=True, )\n"}
{"type": "source_file", "path": "back/database.py", "content": "'''\nAuthor: J.sky bosichong@qq.com\nDate: 2022-11-21 09:45:04\nLastEditors: J.sky bosichong@qq.com\nLastEditTime: 2022-11-24 09:33:37\nFilePath: /MiniAdmin/back/database.py\næ•°æ®åº“ä»¥åŠè¿æ¥çš„é…ç½®.\npythonäº¤æµå­¦ä¹ ç¾¤å·:217840699\n'''\n\nimport os\nimport sys\nfrom sqlalchemy import create_engine\nfrom sqlalchemy.ext.declarative import declarative_base\nfrom sqlalchemy.orm import sessionmaker\n\nimport casbin\nfrom casbin_sqlalchemy_adapter import Adapter\n\n# å°†å½“å‰ç›®å½•æ·»åŠ åˆ°ç³»ç»Ÿå˜é‡ä¸­\nBASE_DIR = os.path.dirname(os.path.abspath(__file__))\nsys.path.append(BASE_DIR)\n\n\n# åˆ›å»ºä¸€ä¸ªä½¿ç”¨å†…å­˜çš„SQLiteæ•°æ®åº“ pytestä¸“ç”¨ã€‚\nSQLALCHEMY_DATABASE_MEMORY = \"sqlite+pysqlite:///:memory:\"\nengine_test = create_engine(SQLALCHEMY_DATABASE_MEMORY, echo=False, )\nSessionLocal_test = sessionmaker(autocommit=False, autoflush=False, bind=engine_test)\n\n\ndef get_db_to_T_E_S_T():\n    '''\n    pytestä¸“ç”¨\n    description: è·å–ä¸€ä¸ªæ•°æ®è¿æ¥ å¼‚æ­¥fastapiä¸‹ä½¿ç”¨.\n    return ssesion\n    '''\n    db = SessionLocal_test()\n    try:\n        yield db\n    finally:\n        db.close()\n\n\n# ç»„è£…æ•°æ®åº“çš„ç»å¯¹åœ°å€\nDB_DIR = os.path.join(BASE_DIR, 'miniadmin_data.db')\n# æ•°æ®åº“è®¿é—®åœ°å€\nSQLALCHEMY_DATABASE_URL = \"sqlite:///\" + DB_DIR\n# åˆ›å»ºç‰©ç†SQLiteæ•°æ®åº“\nengine = create_engine(SQLALCHEMY_DATABASE_URL + '?check_same_thread=False', echo=False, )\n# å¯åŠ¨ä¼šè¯\nSessionLocal = sessionmaker(autocommit=False, autoflush=False, bind=engine, )\n\n\ndef get_db():\n    '''\n    dev\n    description: è·å–ä¸€ä¸ªæ•°æ®è¿æ¥ å¼‚æ­¥fastapiä¸‹ä½¿ç”¨.\n    return ssesion\n    '''\n    db = SessionLocal()\n    try:\n        yield db\n    finally:\n        db.close()\n\n\n# æ•°æ®æ¨¡å‹çš„åŸºç±»\nBase = declarative_base()\n\n# casbin ç›¸å…³é…ç½®\nadapter = Adapter(engine)\nmodel_path = os.path.join(BASE_DIR, 'rbac_model.conf')\n\n\ndef get_casbin_e():\n    \"\"\"\n    è¿”å›ä¸€ä¸ª\n    :return:\n    \"\"\"\n    return casbin.Enforcer(model_path, adapter)\n"}
{"type": "source_file", "path": "back/crud.py", "content": "\"\"\"\nAuthor: J.sky bosichong@qq.com\nDate: 2022-11-22 08:57:09\nLastEditors: J.sky bosichong@qq.com\nLastEditTime: 2022-11-27 22:01:28\nFilePath: /MiniAdmin/back/crud.py\ncrud å·¥å…·\npythonäº¤æµå­¦ä¹ ç¾¤å·:217840699\n\nå…³äºCasbinRule\nåœ¨æœ¬ç³»ç»Ÿä¸­çš„ç»å…¸ä¸‰å…ƒç»„: è®¿é—®å®ä½“ (Role)ï¼Œè®¿é—®èµ„æº (CasbinObject) å’Œè®¿é—®æ–¹æ³• (CasbinAction)ã€‚\nè‹¥å…¶ä¸­çš„ä¸€ä¸ªæ•°æ®çš„keyå‘ç”Ÿä¿®æ”¹,åˆ™åº”ä¿®æ”¹CasbinRuleé‡Œå­˜å‚¨çš„è§„åˆ™,å› ä¸ºCasbinRuleé‡Œå€¼å­˜å‚¨å­—ç¬¦ä¸²,æ‰€ä»¥åªèƒ½è‡ªå·±å†™åˆ¤æ–­.\n\"\"\"\n\nfrom sqlalchemy.orm import Session\nfrom models import User, CasbinAction, CasbinObject, Role, CasbinRule\nfrom utils import verify_password, get_password_hash\nfrom utils import logger\n\nimport random\n\n\ndef create_data(db: Session):\n    \"\"\"\n    æ·»åŠ è¶…çº§ç®¡ç†å‘˜å’Œä¸€äº›æ™®é€šçš„ç”¨æˆ·ã€‚\n    :param db:\n    :return:\n    \"\"\"\n\n    # åˆ›å»ºè¶…çº§ç®¡ç†å‘˜\n    hashed_password = get_password_hash('123456')\n    if not get_user_by_username(db, \"miniadmin\"):\n        add_user(db, User(username='miniadmin', hashed_password=hashed_password, email='admin@example.com', remark='è¶…çº§ç®¡ç†å‘˜ï¼Œæ‹¥æœ‰æ‰€æœ‰æƒé™'))\n        logger.info(\"åˆ›å»ºè¶…çº§ç®¡ç†å‘˜ï¼šminiadmin\")\n    user = get_user_by_username(db, \"miniadmin\")\n\n    if get_role_count(db) <= 0:\n        # åˆ›å»ºè§’è‰²role\n        create_role(db, Role(name='è¶…çº§ç®¡ç†å‘˜', role_key='role_superminiadmin', description='è¶…çº§ç®¡ç†å‘˜,æ‹¥æœ‰æ‰€æœ‰ç³»ç»Ÿæƒé™', user=user))\n        create_role(db, Role(name='ç®¡ç†å‘˜', role_key='role_miniadmin', description='æ‹¥æœ‰å¤§éƒ¨åˆ†ç®¡ç†æƒé™', user=user))\n        create_role(db, Role(name='æ™®é€šç”¨æˆ·', role_key='role_generaluser', description='é»˜è®¤æ³¨å†Œçš„ç”¨æˆ·', user=user))\n\n    if get_casbin_action_count(db) <= 0:\n        # åˆ›å»ºCasbinAction\n        cas = [\n            CasbinAction(name='å¢', action_key='create', description='å¢åŠ æ•°æ®', user=user),\n            CasbinAction(name='åˆ ', action_key='delete', description='åˆ é™¤æ•°æ®', user=user),\n            CasbinAction(name='æ”¹', action_key='update', description='æ›´æ–°æ•°æ®', user=user),\n            CasbinAction(name='æŸ¥', action_key='read', description='è¯»å–æˆ–æŸ¥è¯¢æ•°æ®', user=user),\n            CasbinAction(name='æ˜¾', action_key='show', description='æ•°æ®ç›¸å…³ç»„ä»¶çš„æ˜¾ç¤º', user=user),\n        ]\n        add_casbin_actions(db, cas)\n\n    if get_casbin_object_count(db) <= 0:\n        # åˆ›å»ºCasbinObject\n        cos = [\n            CasbinObject(name='ç”¨æˆ·ç®¡ç†:', object_key='User', description='Userè¡¨--ç”¨æˆ·ç›¸å…³æƒé™', user=user, ),\n            CasbinObject(name='è§’è‰²ç®¡ç†:', object_key='Role', description='Role--è§’è‰²ç›¸å…³æƒé™', user=user, ),\n            CasbinObject(name='èµ„æºç®¡ç†:', object_key='CasbinObject', description='CasbinObject--èµ„æºç›¸å…³æƒé™', user=user, ),\n            CasbinObject(name='åŠ¨ä½œç®¡ç†:', object_key='CasbinAction', description='CasbinActionè¡¨--åŠ¨ä½œç›¸å…³æƒé™', user=user, ),\n        ]\n        add_casbin_objects(db, cos)\n\n    if get_casbin_rule_count(db) <= 0:\n        logger.info(\"è®¾ç½®ç”¨æˆ·ç»„æƒé™\")\n        set_user_role(db)\n        logger.info(\"è®¾ç½®è¶…çº§ç®¡ç†å‘˜\")\n        role_superadmin = get_role_by_id(db, 1)  # è¶…çº§ç®¡ç†å‘˜ç»„\n        create_casbin_rule_g(db, CasbinRule(ptype='g', v0=user.username, v1=role_superadmin.role_key))\n        logger.info(\"ç”Ÿæˆä¸€äº›æ™®é€šç”¨æˆ·ã€‚\")\n        create_temp_users(db)\n\n\ndef set_user_role(db: Session):\n    \"\"\"\n    è®¾ç½®è¶…çº§ç®¡ç†å‘˜ç»„å’Œæ™®é€šç”¨æˆ·ç»„æƒé™\n    :param db:\n    :return:\n    \"\"\"\n    role_superadmin = get_role_by_id(db, 1)  # è¶…çº§ç®¡ç†å‘˜ç»„\n    cas = get_casbin_actions(db)  # æ‰€æœ‰åŠ¨ä½œ\n    cos = get_casbin_objects(db)  # æ‰€æœ‰èµ„æº\n    crs = []\n    for co in cos:\n        for ca in cas:\n            crs.append(CasbinRule(ptype='p', v0=role_superadmin.role_key, v1=co.object_key, v2=ca.action_key))\n    # ä¸ºè¶…çº§ç®¡ç†å‘˜å¢åŠ æ‰€æœ‰policy\n    create_casbin_rules(db, crs)\n\n    role_user = get_role_by_id(db, 3)  # æ™®é€šç”¨æˆ·\n    cos = get_casbin_objects(db)  # æ‰€æœ‰èµ„æº\n    cas1 = ['read', 'show']  # åªè¯»æƒé™\n    crs1 = []\n    for co in cos:\n        for ca in cas1:\n            crs1.append(CasbinRule(ptype='p', v0=role_user.role_key, v1=co.object_key, v2=ca))\n    # ä¸ºæ™®é€šç”¨æˆ·ç»„å¢åŠ æ‰€æœ‰policy\n    create_casbin_rules(db, crs1)\n\n\ndef create_temp_users(db: Session):\n    \"\"\"\n    æ·»åŠ æµ‹è¯•ç”¨æˆ·ï¼Œå¹¶æ·»åŠ æ™®é€šç”¨æˆ·ç»„æƒé™\n    :param db:\n    :return:\n    \"\"\"\n    # æ·»åŠ ä¸€äº›ç”¨æˆ·\n    hashed_password = get_password_hash('123456')\n    role_user = get_role_by_id(db, 3)  # æ™®é€šç”¨æˆ·ç»„\n    if get_users_count(db) <= 1:\n        for i in range(58):\n            sex = str(random.randint(0, 1))\n            is_active = False\n            if random.randint(0, 1): is_active = True\n            k = str(i)\n            u = User(username='mini' + k, hashed_password=hashed_password, email='admin' + k + '@example.com',\n                     sex=sex, is_active=is_active, remark='ä¸´æ—¶æµ‹è¯•ç”¨æˆ·')\n            user = add_user(db, u)\n            create_casbin_rule_g(db, CasbinRule(ptype='g', v0=user.username, v1=role_user.role_key))\n\n\ndef create_user(db: Session, username: str, password: str, sex: str, email: str):\n    \"\"\"\n    åˆ›å»ºä¸€ä¸ªæ–°ç”¨æˆ·\n    :param db:\n    :param username:\n    :param password:\n    :param sex:\n    :param email:\n    :return:\n    \"\"\"\n    role_user = get_role_by_id(db, 3)  # æ™®é€šç”¨æˆ·ç»„\n    hashed_password = get_password_hash(password)\n    user = User()\n    user.username = username\n    user.hashed_password = hashed_password\n    user.email = email\n    user.sex = sex\n    user = add_user(db, user)\n    create_casbin_rule_g(db, CasbinRule(ptype='g', v0=user.username, v1=role_user.role_key))  # æ·»åŠ æ™®é€šç”¨æˆ·æƒé™\n    return True\n\n\ndef add_user(db: Session, user: User):\n    \"\"\"\n    :param db:\n    :param user:\n    :return:\n    \"\"\"\n    db.add(user)\n    db.commit()\n    db.refresh(user)\n    return user\n\n\ndef get_user_by_id(db: Session, id: int):\n    return db.query(User).filter(User.id == id).first()\n\n\ndef get_user_by_username(db: Session, username: str):\n    return db.query(User).filter_by(username=username).first()\n\n\ndef active_change(db: Session, user_id):\n    \"\"\"\n    ä¿®æ”¹ç”¨æˆ·é”å®š\n    :param db:\n    :param id:\n    :return:\n    \"\"\"\n    user = get_user_by_id(db, user_id)\n    if user:\n        user.is_active = not user.is_active\n        db.commit()\n        return True\n    else:\n        return False\n\n\ndef change_user_password(db: Session, old_password: str, new_password: str, user_id: int):\n    \"\"\"\n    description: è¾“å…¥æ—§å¯†ç æ ¡éªŒ,æˆåŠŸå,ä¿®æ”¹æ–°å¯†ç .\n    return {*}\n    \"\"\"\n    user = get_user_by_id(db, user_id)\n    if verify_password(old_password, user.hashed_password):\n        user.hashed_password = get_password_hash(new_password)\n        db.commit()\n        return True\n    else:\n        return False\n\n\ndef get_users(db: Session, offset: int, limit: int, keyword: str):\n    return db.query(User).order_by(-User.id).filter(User.username.like(\"%\" + keyword + \"%\")).offset(offset).limit(limit).all()\n\n\ndef get_users_count_by_keyword(db: Session, keyword: str):\n    return db.query(User).filter(User.username.like(\"%\" + keyword + \"%\")).count()\n\n\ndef get_users_count(db: Session):\n    \"\"\"\n    return å½“å‰ç³»ç»Ÿçš„ç”¨æˆ·æ•°é‡\n    :param db:\n    :return:\n    \"\"\"\n    return db.query(User).count()\n\n\ndef delete_user_by_id(db: Session, user_id: int):\n    try:\n        user = db.query(User).filter_by(id=user_id).first()\n        crs = get_casbin_rules_by_username(db, user.username)\n        for cr in crs:\n            db.delete(cr)\n        db.delete(user)\n        db.commit()\n        return True\n    except Exception as e:\n        return False\n\n\ndef change_user_role(db: Session, user_id: int, role_keys: list[str]):\n    \"\"\"\n    æ”¹å˜ç”¨æˆ·æ‰€å±çš„ç”¨æˆ·ç»„\n    :param db:\n    :param user_id:\n    :param role_key:\n    :return:\n    \"\"\"\n\n    user = db.query(User).filter_by(id=user_id).first()\n    crs = db.query(CasbinRule).filter_by(ptype='g', v0=user.username).all()\n    if len(crs) > 0:\n        delete_p_casbin_rules(db, crs)  # åˆ é™¤è¯¥ç”¨èƒ¡æ‰€æ‹¥æœ‰çš„ç”¨æˆ·ç»„role\n    new_crs = []\n    for role_key in role_keys:\n        new_crs.append(CasbinRule(ptype='g', v0=user.username, v1=role_key))\n    # print(new_crs)\n    try:\n        create_casbin_rules(db, new_crs)\n        return True\n    except:\n        return False\n\n\n# Role\n\ndef get_roles(db: Session):\n    return db.query(Role).all()\n\n\ndef create_role(db: Session, role: Role):\n    db.add(role)\n    try:\n        db.commit()\n        return role\n    except:\n        return False\n\n\ndef get_role_count(db: Session):\n    return db.query(Role).count()\n\n\ndef get_role_by_id(db: Session, role_id: int):\n    \"\"\"\n    description: æ ¹æ®role_idè¿”å›ä¸€ä¸ªrole\n    return role\n    \"\"\"\n    return db.query(Role).filter_by(id=role_id).first()\n\n\ndef get_role_by_name(db: Session, name: str):\n    return db.query(Role).filter_by(name=name).first()\n\n\ndef get_role_by_role_key(db: Session, role_key: str):\n    return db.query(Role).filter_by(role_key=role_key).first()\n\n\ndef update_role_by_id(db: Session, old_role_id, new_role):\n    \"\"\"\n    æ›´æ–°role,éœ€è¦æ›´æ–°casein_ruleé‡Œçš„æ•°æ®\n    :param db:\n    :param old_role_id:\n    :param new_role:\n    :return:\n    \"\"\"\n    role = get_role_by_id(db, old_role_id)\n    old_role_key = role.role_key\n    if role:\n        role.name = new_role.name\n        role.role_key = new_role.role_key\n        role.description = new_role.description\n        db.commit()\n\n        # æ›´æ–°ç›¸å…³çš„casbin_ruleå…³è”ç”¨æˆ·ç»„çš„role_key\n        crs = _get_casbin_rules_by_ptype_g_v1(db, old_role_key)\n        for cr in crs:\n            cr.v1 = new_role.role_key\n        db.commit()\n\n        # æ›´æ–°ç›¸å…³çš„casbin_ruleå…³è”èµ„æºåŠ¨ä½œçš„role_key\n        crs = _get_casbin_rules_by_ptype_p_v0(db, old_role_key)\n        for cr in crs:\n            cr.v0 = new_role.role_key\n        db.commit()\n        return True\n    else:\n        return False\n\n\ndef delete_role_by_id(db: Session, role_id):\n    \"\"\"\n    description: åˆ é™¤role,ä»¥åŠç›¸å…³çš„casbin_rule\n\n    return {bool}\n    \"\"\"\n    role = get_role_by_id(db, role_id)\n    if role:\n        # åˆ é™¤casbin_ruleé‡Œçš„ç”¨æˆ·ç»„\n        crs = _get_casbin_rules_by_ptype_g_v1(db, role.role_key)\n        for cr in crs:\n            db.delete(cr)\n        db.commit()\n        # åˆ é™¤casein_ruleé‡Œçš„ç›¸å…³rule\n        crs = _get_casbin_rules_by_ptype_p_v0(db, role.role_key)\n        for cr in crs:\n            db.delete(cr)\n        db.commit()\n        db.delete(role)\n        db.commit()\n        return True\n    else:\n        return False\n\n\ndef change_role_casbinrules(db: Session, role_key: str, crs: list[CasbinRule]):\n    \"\"\"\n    ä¿®æ”¹roleè§’è‰²æ‰€æ‹¥æœ‰çš„æƒé™ï¼Œå…ˆåˆ é™¤roleåœ¨casbinruleé‡ŒåŸæœ‰çš„æ‰€æœ‰æ•°æ®ï¼Œç„¶åæ·»åŠ å‰ç«¯å‘æ¥çš„æ‰€æœ‰æ–°æ•°æ®ã€‚\n    crsæ˜¯ä¸€ä¸ªlist,åŒ…æ‹¬ä¸€ç»„éœ€è¦æ·»åŠ åˆ°casbinruleçš„è§„åˆ™ã€‚\n    :param db:\n    :param role_key:\n    :param crs:\n    :return: bool\n    \"\"\"\n    try:\n        delete_casbin_rules(db, role_key)\n        create_casbin_rules(db, crs)\n        return True\n    except:\n        return False\n\n\n# CasbinAction åŠ¨ä½œ\n\ndef get_casbin_action_count(db: Session):\n    return db.query(CasbinAction).count()\n\n\ndef create_casbin_action(db: Session, casbinaction: CasbinAction):\n    try:\n        db.add(casbinaction)\n        db.commit()\n        return True\n    except:\n        return False\n\n\ndef add_casbin_actions(db: Session, casbinactions):\n    for c in casbinactions:\n        db.add(c)\n    db.commit()\n\n\ndef get_casbin_action_by_id(db: Session, id: int):\n    return db.query(CasbinAction).filter_by(id=id).first()\n\n\ndef update_casbin_action_by_id(db: Session, old_id: int, name: str, action_key: str, description: str):\n    \"\"\"\n    ä¿®æ”¹casbin_action\n    :param db:\n    :param old_id:\n    :param name:\n    :param action_key:\n    :param description:\n    :return:\n    \"\"\"\n    ca = get_casbin_action_by_id(db, old_id)\n    temp_key = ca.action_key\n    if ca:\n        ca.name = name\n        ca.action_key = action_key  # å¦‚æœaction_key,åº”å½“æ›´æ–°CasbinRuleé‡Œçš„æ•°æ®\n        ca.description = description\n        db.commit()\n        if temp_key != action_key:\n            crs = get_casbin_rules_by_act_key(db, temp_key)\n            for cr in crs:\n                cr.v2 = action_key\n            db.commit()\n        return ca\n    else:\n        return False\n\n\ndef delete_casbin_action_by_id(db: Session, ac_id: int):\n    \"\"\"\n    åˆ é™¤casbin_actionï¼ŒåŒæ—¶åˆ é™¤casbinruleä¸­å­˜åœ¨çš„åŠ¨ä½œrule\n    :param db: db\n    :param ac_id: int\n    :return: bool\n    \"\"\"\n    ac = get_casbin_action_by_id(db, ac_id)\n    ac_key = ac.action_key\n    if ac:\n        db.delete(ac)\n        crs = get_casbin_rules_by_act_key(db, ac_key)\n        for cr in crs:\n            db.delete(cr)\n        db.commit()\n        return True\n    else:\n        return False\n\n\ndef get_casbin_actions(db: Session, ):\n    return db.query(CasbinAction).all()\n\n\n# CasbinObject èµ„æº\n\n\ndef get_casbin_object_count(db: Session):\n    return db.query(CasbinObject).count()\n\n\ndef create_casbin_object(db: Session, casbinobject: CasbinObject):\n    try:\n        db.add(casbinobject)\n        db.commit()\n        return True\n    except:\n        return False\n\n\ndef add_casbin_objects(db: Session, casbinobjects):\n    for co in casbinobjects:\n        db.add(co)\n    db.commit()\n\n\ndef get_casbin_objects(db: Session):\n    return db.query(CasbinObject).all()\n\n\ndef get_casbin_object_by_id(db: Session, id: int):\n    return db.query(CasbinObject).filter_by(id=id).first()\n\n\ndef update_casbin_object(db: Session, old_id, name, obj_key, description):\n    \"\"\"\n    æ›´æ–°casein_object\n    :param db:\n    :param old_id:\n    :param name:\n    :param obj_key:\n    :param description:\n    :return:\n    \"\"\"\n    co = get_casbin_object_by_id(db, old_id)\n    if co:\n        temp_key = co.object_key\n        co.name = name\n        co.object_key = obj_key\n        co.description = description\n        db.commit()\n        if temp_key != obj_key:\n            cos = get_casbin_rules_by_obj_key(db, temp_key)\n            for co in cos:\n                co.v1 = obj_key\n            db.commit()\n        return True\n    else:\n        return False\n\n\ndef delete_casbin_object_by_id(db: Session, ac_id: int):\n    \"\"\"\n    åˆ é™¤casbin_actionï¼ŒåŒæ—¶åˆ é™¤casbinruleä¸­å­˜åœ¨çš„åŠ¨ä½œ\n    :param db: db\n    :param ac_id: int\n    :return: bool\n    \"\"\"\n    obj = get_casbin_object_by_id(db, ac_id)\n    obj_key = obj.object_key\n    if obj:\n        db.delete(obj)\n        crs = get_casbin_rules_by_obj_key(db, obj_key)\n        for cr in crs:\n            db.delete(cr)\n        db.commit()\n        return True\n    else:\n        return False\n\n\n# CasbinRule æƒé™éªŒè¯æ ¸å¿ƒ\n\ndef delete_casbin_rules(db, role_key):\n    \"\"\"\n    æ‰¹é‡åˆ é™¤casbinrulesï¼ŒæˆåŠŸè¿”å›æ¡æ•°ï¼Œè‹¥è¿”å›0åˆ™è¡¨ç¤ºæ²¡æœ‰å­˜åœ¨çš„æ•°æ®ã€‚\n    :param db:\n    :param role_key:\n    :return:\n    \"\"\"\n    crs = _get_casbin_rules_by_ptype_p_v0(db, role_key)\n    if len(crs) > 0:\n        for cr in crs:\n            db.delete(cr)\n        db.commit()\n        return len(crs)\n    else:\n        return 0\n\n\ndef get_casbin_rules_by_obj_key(db: Session, obj_key):\n    return db.query(CasbinRule).filter_by(v1=obj_key).all()\n\n\ndef get_casbin_rules_by_act_key(db: Session, act_key: str):\n    \"\"\"\n    æ ¹æ®act_keyè¿”å›ä¸€ç»„CasbinRules\n    :param db:\n    :param act_key:\n    :return: crs\n    \"\"\"\n    return db.query(CasbinRule).filter_by(v2=act_key).all()\n\n\ndef filter_casbin_rule_by_role_key(db: Session, role_key):\n    '''\n    description: \n    æ ¹æ®role_keyè¿”å›æ­¤è§’è‰²roleçš„æƒé™æ•°æ®,ä¿®æ”¹è§’è‰²çš„æƒé™æ˜¯ä¼šé‡æ–°æ·»åŠ æ•°æ®\n    return {list}\n    '''\n    return db.query(CasbinRule).filter_by(ptype=\"p\", v0=role_key).all()\n\n\ndef filter_casbin_rule_g(db: Session, casbinrule):\n    '''\n    description: æŸ¥è¯¢è¡¨ä¸­æ˜¯å¦å­˜åœ¨ç›¸åŒçš„è§’è‰²roleè®¾ç½®\n    return {*}\n    '''\n    return db.query(CasbinRule).filter_by(ptype=casbinrule.ptype, v0=casbinrule.v0, v1=casbinrule.v1).all()\n\n\ndef filter_casbin_rule(db: Session, casbinrule):\n    '''\n    description: æŸ¥è¯¢æ˜¯å¦å­˜åœ¨ç›¸åŒçš„policy\n    return {*}\n    '''\n    return db.query(CasbinRule).filter_by(ptype=casbinrule.ptype, v0=casbinrule.v0, v1=casbinrule.v1,\n                                          v2=casbinrule.v2).first()\n\n\ndef create_casbin_rules(db: Session, crs):\n    \"\"\"\n    å› ä¸ºå‰ç«¯æ·»åŠ policyéƒ½æ˜¯å¤šæ¡,æ‰€ä»¥æ¥å£åªæš´éœ²æ‰¹é‡æ·»åŠ .\n    æ·»åŠ policyåˆ°æ•°æ®è¡¨ä¸­,å¦‚æœæœ‰ç›¸åŒçš„policy,åˆ™ä¸å†ç»§ç»­æ·»åŠ .\n    return\n    :param db:\n    :param crs:\n    :return: {è¡¨ä¸­å­˜åœ¨çš„ç›¸åŒæ•°æ®çš„æ¡ç›®}\n    \"\"\"\n    k = 0\n    for cr in crs:\n        if filter_casbin_rule(db, cr):\n            k += 1\n        else:\n            _add_casbin_rule(db, cr)\n    return k\n\n\ndef create_casbin_rule_g(db: Session, cr_g):\n    \"\"\"\n    è®¾ç½®ç”¨æˆ·çš„æƒé™ç»„\n    :param db:\n    :param cr_g: ä¸€ä¸ªcasbinrule ptype=\"g\"\n    :return: å­˜åœ¨è¿”å›1 ä¸å­˜åœ¨åˆ™å¢åŠ æ•°æ®å¹¶è¿”å›0,å¹¶æ·»åŠ è¯¥ç”¨æˆ·åˆ°æƒé™ç»„\n    \"\"\"\n    k = filter_casbin_rule_g(db, cr_g)\n    if k:\n        return k\n    else:\n        _add_casbin_rule(db, cr_g)\n        return 0\n\n\ndef get_casbin_rule_count(db: Session):\n    return db.query(CasbinRule).count()\n\n\ndef get_users_by_casbinrule_role_key(db: Session, role_key):\n    '''\n    description: æ ¹æ®role.keyè¿”å›å½“å‰ç»„çš„ç”¨æˆ·\n    return {*} å½“å‰è§’è‰²ç»„çš„æ‰€æœ‰æˆå‘˜\n    '''\n    crs = db.query(CasbinRule).filter_by(ptype='g', v1=role_key).all()\n    users = []\n    for cr in crs:\n        user = get_user_by_username(db, cr.v0)\n        users.append(user)\n    return crs\n\n\ndef get_casbin_rules_by_role_key(db: Session, role_key):\n    '''\n    description: \n    return {*} è¯¥æƒé™ç»„æ‰€åŒ…æ‹¬çš„æ‰€æœ‰æƒé™casbinrule\n    '''\n    return db.query(CasbinRule).filter_by(ptype=\"p\", v0=role_key).all()\n\n\ndef delete_p_casbin_rules(db: Session, roles):\n    '''\n    description: åˆ é™¤è¯¥æƒé™ç»„çš„æ‰€æœ‰casbinrule\n    return {*}\n    '''\n    for r in roles:\n        db.delete(r)\n    db.commit()\n\n\ndef get_casbin_rules_by_username(db: Session, username: str):\n    '''\n    description: æ ¹æ®ç”¨æˆ·å,è¿”å›å…¶roleè§’è‰²ç»„çš„æ•°æ®\n\n    param {Session} db\n\n    param {*} username str \n    \n    return {*} crs\n    '''\n    return db.query(CasbinRule).filter_by(ptype='g', v0=username).all()\n\n\ndef _get_casbin_rules_by_ptype_g_v1(db: Session, role_key: str):\n    '''\n    description: è¿”å›è¢«è®¾ç½®çš„è¯¥è§’è‰²çš„æ‰€æœ‰ç®¡ç†å‘˜æ•°æ®,ç”¨æ¥æ›´æ–°æˆ–åˆ é™¤è¿™äº›æ•°æ®.\n\n    param {Session} db\n\n    param {*} role_key æ ¹ç»role_keyè¿›è¡Œæœç´¢\n    \n    return {*} crs\n    '''\n    return db.query(CasbinRule).filter_by(ptype=\"g\", v1=role_key).all()\n\n\ndef _get_casbin_rules_by_ptype_p_v0(db: Session, role_key: str):\n    '''\n    description: è¿”å›è¯¥è§’è‰²çš„æ‰€æœ‰èµ„æºåŠ¨ä½œè®¾ç½®æ•°æ®,ç”¨æ¥æ›´æ–°æˆ–åˆ é™¤è¿™äº›æ•°æ®.\n    param {Session} db\n    param {*} role_key æ ¹æ®role_keyè¿›è¡Œæœç´¢\n    return {*} crs\n    '''\n    return db.query(CasbinRule).filter_by(ptype='p', v0=role_key).all()\n\n\ndef _add_casbin_rule(db: Session, casbinrule):\n    '''\n    description: å¢åŠ ä¸€æ¡casbinrule\n    return {*}\n    '''\n    db.add(casbinrule)\n    db.commit()\n\n\ndef _get_casbin_rules(db: Session):\n    return db.query(CasbinRule).all()\n"}
{"type": "source_file", "path": "back/models.py", "content": "'''\nAuthor: J.sky bosichong@qq.com\nDate: 2022-11-21 14:41:49\nLastEditors: J.sky bosichong@qq.com\nLastEditTime: 2022-11-26 11:20:42\nFilePath: /MiniAdmin/back/models.py\npythonäº¤æµå­¦ä¹ ç¾¤å·:217840699\nmodel,sub, obj, act è¡¨ç¤ºç»å…¸ä¸‰å…ƒç»„: è®¿é—®å®ä½“ (Subject)ï¼Œè®¿é—®èµ„æº (Object) å’Œè®¿é—®æ–¹æ³• (Action)ã€‚\n'''\n\nfrom datetime import datetime\nfrom database import Base\nfrom sqlalchemy import String, Column, Integer, DateTime, ForeignKey, Boolean\nfrom sqlalchemy.orm import relationship\n\n\nclass User(Base):\n    __tablename__ = 'user'\n    # è‹¥æœ‰å¤šä¸ªç±»æŒ‡å‘åŒä¸€å¼ è¡¨ï¼Œé‚£ä¹ˆåœ¨åè¾¹çš„ç±»éœ€è¦æŠŠ extend_existingè®¾ä¸ºTrueï¼Œè¡¨ç¤ºåœ¨å·²æœ‰åˆ—åŸºç¡€ä¸Šè¿›è¡Œæ‰©å±•\n    # æˆ–è€…æ¢å¥è¯è¯´ï¼Œsqlalchemy å…è®¸ç±»æ˜¯è¡¨çš„å­—é›†ï¼Œå¦‚ä¸‹ï¼š\n    __table_args__ = {'extend_existing': True}\n\n    id = Column(Integer, primary_key=True, autoincrement=True, comment='ç”¨æˆ·ID')\n    username = Column(String(32), nullable=False, unique=True, comment='ç”¨æˆ·æ˜µç§°')\n    hashed_password = Column(String(128), nullable=False, comment='ç”¨æˆ·å¯†ç ')\n    sex = Column(String(1), nullable=False, default='1', comment='ç”¨æˆ·æ€§åˆ«')\n    email = Column(String(128), nullable=False, unique=True, comment='ç”¨æˆ·é‚®ç®±')\n    is_active = Column(Boolean, default=False)\n    avatar = Column(String(128), comment='ç”¨æˆ·å¤´åƒ')\n    remark = Column(String(128), comment='å¤‡æ³¨')\n    create_time = Column(DateTime, nullable=False, default=datetime.now, comment='åˆ›å»ºæ—¶é—´')\n    update_time = Column(DateTime, nullable=False, default=datetime.now, onupdate=datetime.now, comment='æ›´æ–°æ—¶é—´')\n\n    roles = relationship('Role', uselist=True, back_populates='user')\n    cos = relationship('CasbinObject', uselist=True, back_populates='user')\n    cas = relationship('CasbinAction', uselist=True, back_populates='user')\n\n\nclass Role(Base):\n    __tablename__ = 'role'\n    __table_args__ = {'extend_existing': True}\n\n    id = Column(Integer, primary_key=True, autoincrement=True, comment='è§’è‰²id')\n    name = Column(String(32), nullable=False, unique=True, comment='è§’è‰²åç§°')\n    role_key = Column(String(128), nullable=False, unique=True, comment='è§’è‰²æ ‡è¯†')\n    description = Column(String(128), nullable=False, comment='è§’è‰²æè¿°')\n    create_time = Column(DateTime, nullable=False, default=datetime.now, comment='åˆ›å»ºæ—¶é—´')\n    update_time = Column(DateTime, nullable=False, default=datetime.now, onupdate=datetime.now, comment='æ›´æ–°æ—¶é—´')\n    user_id = Column(Integer, ForeignKey('user.id'), nullable=False, comment='åˆ›å»ºè€…')\n    user = relationship('User', back_populates='roles')\n\n\nclass CasbinObject(Base):\n    __tablename__ = 'casbin_object'\n    __table_args__ = {'extend_existing': True}\n\n    id = Column(Integer, primary_key=True, autoincrement=True, comment='ID')\n    name = Column(String(128), nullable=False, unique=True, comment='èµ„æºåç§°')\n    object_key = Column(String(128), nullable=False, unique=True, comment='èµ„æºæ ‡è¯†')\n    description = Column(String(128), nullable=True, comment='èµ„æºæè¿°')\n    create_time = Column(DateTime, nullable=False, default=datetime.now, comment='åˆ›å»ºæ—¶é—´')\n    update_time = Column(DateTime, nullable=False, default=datetime.now, onupdate=datetime.now, comment='æ›´æ–°æ—¶é—´')\n    user_id = Column(Integer, ForeignKey('user.id'), nullable=False, comment='åˆ›å»ºè€…')\n    user = relationship('User', back_populates='cos')\n\n\nclass CasbinAction(Base):\n    __tablename__ = 'casbin_action'\n    __table_args__ = {'extend_existing': True}\n\n    id = Column(Integer, primary_key=True, autoincrement=True, comment='ID')\n    name = Column(String(128), nullable=False, unique=True, comment='åŠ¨ä½œåç§°')\n    action_key = Column(String(128), nullable=False, unique=True, comment='åŠ¨ä½œæ ‡è¯†')\n    description = Column(String(128), nullable=True, comment='åŠ¨ä½œæè¿°')\n    create_time = Column(DateTime, nullable=False, default=datetime.now, comment='åˆ›å»ºæ—¶é—´')\n    update_time = Column(DateTime, nullable=False, default=datetime.now, onupdate=datetime.now, comment='æ›´æ–°æ—¶é—´')\n\n    user_id = Column(Integer, ForeignKey('user.id'), nullable=False, comment='åˆ›å»ºè€…')\n    user = relationship('User', back_populates='cas')\n\n\nclass CasbinRule(Base):\n    __tablename__ = \"casbin_rule\"\n    __table_args__ = {'extend_existing': True}\n\n    id = Column(Integer, primary_key=True)\n    ptype = Column(String(255))\n    v0 = Column(String(255))\n    v1 = Column(String(255))\n    v2 = Column(String(255))\n    v3 = Column(String(255))\n    v4 = Column(String(255))\n    v5 = Column(String(255))\n"}
{"type": "source_file", "path": "back/schemas.py", "content": "# -*- coding: UTF-8 -*-\n\"\"\"\n@Author   : J.sky\n@Mail     : bosichong@qq.com\n@Site     : https://github.com/bosichong\n@QQäº¤æµç¾¤  : pythonäº¤æµå­¦ä¹ ç¾¤å·:217840699\n@file      :schemas.py\n@time     :2022/11/29\n\n\"\"\"\nfrom typing import Union\n\nfrom pydantic import BaseModel\n\n\nclass Token(BaseModel):\n    access_token: str\n    token_type: str\n\n\nclass TokenData(BaseModel):\n    username: Union[str, None] = None\n\n\nclass UserBase(BaseModel):\n    email: str\n\n\nclass UserCreate(UserBase):\n    username: str\n    password: str\n    sex: str\n\n\nclass User(UserBase):\n    id: int\n    username: str\n    sex: str\n    email: str\n    is_active: bool\n    avatar: Union[str, None] = None\n    remark: Union[str, None] = None\n\n    class Config:\n        orm_mode = True\n\n\nclass UserUpdate(BaseModel):\n    user_id: int\n    username: str\n    password: Union[str, None] = ''\n    sex: str\n    email: str\n    avatar: Union[str, None] = None\n    remark: Union[str, None] = None\n\n\nclass Users(BaseModel):\n    users: list[User]\n    count: int\n\n\nclass Role(BaseModel):\n    name: str\n    role_key: str\n    description: str\n    user_id: str\n\n\nclass EditRole(BaseModel):\n    old_role_id: int\n    name: str\n    role_key: str\n    description: str\n\n\nclass createCasbinObject(BaseModel):\n    name: str\n    object_key: str\n    description: str\n    user_id: int\n\n\nclass EditCasbinObject(BaseModel):\n    old_co_id: int\n    name: str\n    object_key: str\n    description: str\n\n\nclass createCasbinAction(BaseModel):\n    name: str\n    action_key: str\n    description: str\n    user_id: int\n\n\nclass EditCasbinAction(BaseModel):\n    old_ca_id: int\n    name: str\n    action_key: str\n    description: str\n\n\nclass ChangeRole(BaseModel):\n    role_id: int\n    checkeds: list\n\n\nclass ChangeUserRole(BaseModel):\n    user_id: int\n    names: list[str]\n\n\nclass Casbin_rule(BaseModel):\n    obj: str\n    act: str\n\n"}
{"type": "source_file", "path": "back/utils.py", "content": "'''\nAuthor: J.sky bosichong@qq.com\nDate: 2022-11-22 09:03:48\nLastEditors: J.sky bosichong@qq.com\nLastEditTime: 2022-11-27 10:06:04\nFilePath: /MiniAdmin/back/utils.py\nå·¥å…·ç±»,å¯†ç ã€éªŒè¯ã€æƒé™éªŒè¯ç­‰\npythonäº¤æµå­¦ä¹ ç¾¤å·:217840699\n'''\n\nimport os\nimport sys\nfrom functools import wraps\n\nfrom passlib.context import CryptContext\nfrom pydantic import BaseSettings\nfrom fastapi import HTTPException, status\nfrom jose import JWTError, jwt\nfrom fastapi.security import OAuth2PasswordBearer\nfrom loguru import logger\nfrom database import BASE_DIR, get_casbin_e, get_db\nfrom models import User\n\nLOG_LEVEL = \"DEBUG\"\nlogger.remove()  # åˆ å»import loggerä¹‹åè‡ªåŠ¨äº§ç”Ÿçš„handlerï¼Œä¸åˆ é™¤çš„è¯ä¼šå‡ºç°é‡å¤è¾“å‡ºçš„ç°è±¡\nlogger.add(os.path.join(BASE_DIR, \"logs/logger.log\"), level=LOG_LEVEL)\nhandler_id = logger.add(sys.stderr, level=LOG_LEVEL)\n\n# æ‰§è¡Œç”Ÿæˆtokençš„åœ°å€\noauth2_scheme = OAuth2PasswordBearer(tokenUrl=\"/v1/token\")\n\n\nclass AppTokenConfig(BaseSettings):\n    \"\"\"\n    åœ¨ç»ˆç«¯é€šè¿‡ä»¥ä¸‹å‘½ä»¤ç”Ÿæˆä¸€ä¸ªæ–°çš„å¯†åŒ™:\n    openssl rand -hex 32\n    åŠ å¯†å¯†é’¥ è¿™ä¸ªå¾ˆé‡è¦åƒä¸‡ä¸èƒ½æ³„éœ²äº†ï¼Œè€Œä¸”ä¸€å®šè‡ªå·±ç”Ÿæˆå¹¶æ›¿æ¢ã€‚\n    \"\"\"\n    SECRET_KEY = \"ededcbe81f2e015697780d536196c0baa6ea26021ad7070867e40b18a51ff8da\"\n    ALGORITHM = \"HS256\"\n    ACCESS_TOKEN_EXPIRE_MINUTES = 30  # tokenå¤±æ•ˆæ—¶é—´\n\n\n# åˆ›å»ºä¸€ä¸ªtokençš„é…ç½®é¡¹ã€‚\nAPP_TOKEN_CONFIG = AppTokenConfig()\n\n# å¯†ç æ•£åˆ— pwd_context.hash(password)\npwd_context = CryptContext(schemes=[\"bcrypt\"], deprecated=\"auto\")\n\n\ndef verify_password(plain_password, hashed_password):\n    \"\"\"\n    description: æ ¡éªŒå¯†ç \n    return {*} bool\n    \"\"\"\n    return pwd_context.verify(plain_password, hashed_password)\n\n\ndef get_password_hash(password):\n    \"\"\"\n    description: hashå¯†ç \n    return {*} hashed_password\n    \"\"\"\n    return pwd_context.hash(password)\n\n\ndef verify_enforce(token: str, rule):\n    \"\"\"\n    casbinæƒé™éªŒè¯\n    :param token:token\n    :param rule: object ï¼Œaction\n    :return:\n    \"\"\"\n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"æ‚¨çš„å¸æˆ·å·²é”å®šï¼\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n    e = get_casbin_e()  # æ¯æ¬¡éƒ½è¦è°ƒç”¨ï¼Œè·å–æœ€æ–°çš„æƒé™è§„åˆ™ã€‚\n    sub = get_username_by_token(token)  # tokenä¸­è·å–ç”¨æˆ·å\n    # print(sub,rule.obj,rule.act)\n    if not verify_isActive(sub):\n        return e.enforce(sub, rule.obj, rule.act)\n    else:\n        raise credentials_exception\n\n\ndef verify_isActive(username: str):\n    \"\"\"\n    åˆ¤æ–­ç”¨æˆ·æ˜¯å¦é”å®š\n    :param username:\n    :return:\n    \"\"\"\n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"å½“å‰è´¦æˆ·ä¸å­˜åœ¨æˆ–å·²è¢«åˆ é™¤ï¼\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n    user = next(get_db()).query(User).filter_by(username=username).first()\n    if user:\n        return user.is_active\n    else:\n        raise credentials_exception\n\n\ndef verify_e(e, sub, obj, act):\n    return e.enforce(sub, obj, act)\n\n\ndef get_username_by_token(token):\n    \"\"\"\n    ä»tokenä¸­å–å‡ºusername\n    :param token:\n    :return:\n    \"\"\"\n    credentials_exception = HTTPException(\n        status_code=status.HTTP_401_UNAUTHORIZED,\n        detail=\"Could not validate credentials\",\n        headers={\"WWW-Authenticate\": \"Bearer\"},\n    )\n    try:\n        # print('è·å–ç”¨æˆ·å'+token)\n        payload = jwt.decode(token, APP_TOKEN_CONFIG.SECRET_KEY, algorithms=[APP_TOKEN_CONFIG.ALGORITHM])\n        username: str = payload.get(\"sub\")  # ä» tokenä¸­è·å–ç”¨æˆ·å\n        return username\n    except JWTError:\n        raise credentials_exception\n\n\nimport copy\n\n\ndef update_array(original_array, parameters):\n    '''\n    æ‹¼è£…å‰ç«¯æƒé™ç®¡ç†å±•ç¤ºæ•°æ®\n    :param original_array:\n    :param parameters:\n    :return:\n    '''\n    result = copy.deepcopy(original_array)\n\n    for parameter in parameters:\n        # print(parameter)\n        if len(parameter) <= 0:\n            break\n        for original in result:\n            if parameter[0] == original[0]:\n                result[result.index(original)] = parameter\n                break\n    for original in result:\n        if original not in parameters:\n            result[result.index(original)] = []\n\n    return result\n\n\nif __name__ == '__main__':\n    original_array = [['ç”¨æˆ·ç®¡ç†:', 'å¢', 'åˆ ', 'æ”¹', 'æŸ¥', 'æ˜¾'],\n                      ['è§’è‰²ç®¡ç†:', 'å¢', 'åˆ ', 'æ”¹', 'æŸ¥', 'æ˜¾'],\n                      ['èµ„æºç®¡ç†:', 'å¢', 'åˆ ', 'æ”¹', 'æŸ¥', 'æ˜¾'],\n                      ['åŠ¨ä½œç®¡ç†:', 'å¢', 'åˆ ', 'æ”¹', 'æŸ¥', 'æ˜¾']]\n    parameters = [['ç”¨æˆ·ç®¡ç†:', 'æŸ¥', 'æ˜¾'], ['åŠ¨ä½œç®¡ç†:', 'æŸ¥', 'æ˜¾']]\n\n    result = update_array(original_array, parameters)\n    print(result)\n    print(original_array)\n    print(parameters)\n"}
